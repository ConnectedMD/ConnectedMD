<!DOCTYPE html>
<html lang="<%=LANG%>">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0"/>
    <link rel="icon" type="image/ico" href="/favicon.ico"/>
    <title>ConnectedMD</title>
    <link href="/libs/bootstrap/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="/css/animate.min.css" rel="stylesheet"/>
    <link href="/css/app.css" rel="stylesheet"/>
    <link href="/css/features.css" rel="stylesheet"/>

    <link href="/libs/font-awesome/css/font-awesome.min.css" rel="stylesheet"/>
    <link href="/css/pe-icon-7-stroke.css" rel="stylesheet" />
    <link href="/css/medical_icons.css" rel="stylesheet" />
    <link href="/css/raleway-font.css" rel="stylesheet" />
</head>
<body class="login-body">

    <div class="splash-screen" style="display:none;" >
        <div class="splash-screen-overlay"></div>
        <div class="splash-screen-container">
            <div class="splash-screen-brand-container">
                <div class="row">
                    <div class="col-md-12 center-block" style="text-align: center;">
                        <div class="splash-brand-container center-block">
                            <h1 class="splash-brand"><i class="pe-7s-plugin"></i></h1>
                            <!--<h1 class="splash-brand"><i class="fa fa-stethoscope fa-lg"></i></h1>-->
                        </div>
                        <h1 class="login-brand">Minerva</h1>
                        <hr class="login-hr" style="max-width: 40%;" />
                        <h6 class="login-brand-subtext center-block">Feel better &nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;Live better</h6>
                        <br><br>
                        <div style="padding:0 10px;">
                            <h3 style="color: #f1f1f1; font-size: 2rem;">The health platform for practices & patients</h3>
                        </div>
                        <div>
                            <i class="splash-feature flaticon-stethoscope"></i>
                            <i class="splash-feature flaticon-medicine"></i>
                            <i class="splash-feature flaticon-doctor"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="login-trademark">
                <span style="color:#B7B7B7;">&copy; ConnectedMD Inc. 2016</span>
            </div>
        </div>
    </div>

    <div id="login" class="login-view">
        <div class="login-view-overlay"></div>
        <div class="login-container">
            <div class="login-brand-container">
                <div class="row">
                    <div class="col-md-12" style="text-align: center;">
                        <h1 class="login-brand"><i class="pe-7s-plugin"></i></h1>
                        <h1 class="login-brand">
                            Minerva</h1>
                        <hr class="login-hr" />
                        <h6 class="login-brand-subtext center-block">Feel better &nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;Live better</h6>
                    </div>
                </div>
            </div>
            <div class="login-social">
                <button class="btn btn-primary btn-lg btn-fill btn-facebook">Sign in with Facebook</button>
            </div>
            <div class="login-option"><strong>or</strong></div>
            <div class="login-form">
                <div class="row">
                    <div class="col-md-12">
                        <input type="email" class="form-control input-lg login-input" id="email" placeholder="Email"/>
                        <div id="emailError" class="error"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <input type="password" class="form-control input-lg login-input" id="password" placeholder="Password">
                        <div id="passwordError" class="error"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div id="loginError" class="error"></div>
                        <button type="button" class="btn btn-primary btn-lg btn-block login-btn" onclick="login()">Sign in with Email</button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 center-block" style="text-align:center;">
                        <a class="center-block signup-forgot-password" href="javascript:showPanel('forgotPassword')">Forgot Password?</a>
                    </div>
                </div>
            </div>
            <div class="signup-footer">
                <span class="signup-message">Don't have an account?</span>&nbsp;&nbsp;<a id="login_signup" class="sign-up-link">Sign up</a>
            </div>
            <div class="login-trademark">
                <span style="color:#B7B7B7;">&copy; ConnectedMD Inc. 2016</span>
            </div>
        </div>
    </div>

    <div id="register" class="signup-view" style="display:none;">
        <div class="signup-prompt">
            <h4>SIGN UP</h4>
            <span class="signup-subtext">Get started using ConnectedMD with an account</span>
        </div>
        <div class="signup-social">
            <button class="btn btn-primary btn-lg btn-fill signup-btn-social btn-facebook">Signup with Facebook</button>
        </div>
        <div class="signup-form">
            <div class="signup-input-box">
                <input type="email" class="form-control input-lg signup-input" id="registerEmail" placeholder="Email" autocomplete="off">
            </div>
            <div class="signup-input-box">
                <input type="password" class="form-control input-lg signup-input" id="registerPassword" placeholder="Password">
            </div>
            <div class="signup-input-box">
                <input type="password" class="form-control input-lg signup-input" id="registerConfirmPassword" placeholder="Password Again">
            </div>
            <div class="signup-submit-box">
                <button class="btn btn-success btn-fill btn-lg signup-btn-submit">Sign up with Email</button>
            </div>
            <div class="signup-terms-box">
                <span>By signing up for an account, you agree to our</span><br>
                <span class="signup-terms-link"><strong>Terms of Service</strong></span>&nbsp;&&nbsp;
                <span class="signup-terms-link"><strong>Privacy Policy</strong></span>
            </div>
        </div>
    </div>

    <div id="forgotPassword" class="forgot-view"  style="display:none;">
      <div class="forgot-prompt">
          <h1 class="forgot-icon"><i class="pe-7s-door-lock"></i></h1>
          <h3>Forgot your password?</h3>
          <span class="signup-subtext">Enter your email address below and we'll send you a link to reset your password</span>
      </div>
      <div class="signup-form">
          <div class="signup-input-box">
              <input id="forgotPasswordEmail" type="email" class="form-control input-lg signup-input" id="forgotEmail" placeholder="Email" autocomplete="off">
          </div>
          <div class="signup-submit-box">
              <button id="reset_password" class="btn btn-success btn-fill btn-lg signup-btn-submit">Send Reset Email</button>
          </div>
      </div>
      <div class="signup-footer">
         <div>
            <span class="signup-message" style="margin-right:15px; color:#fff;">Return to login?</span>
            <a class="sign-up-link" style="color:#16FFFF;" onclick="showPanel('login')">Click here</a>
         </div>
      </div>
    </div>

    <div id="emailsent" class="forgot-view" style="display:none;">
        <div class="forgot-prompt">
            <div class="forgot-icon-cont center-block">
                <h1 class="forgot-icon"><i class="pe-7s-paper-plane"></i></h1>
            </div>
            <h3>Reset Email Sent</h3>
            <span class="signup-subtext">We've sent an email with instructions to reset your password.</span>
        </div>
        <div class="signup-form">
            <div class="signup-submit-box">
                <a href="" id="to_signin" class="btn btn-success btn-fill btn-lg signup-btn-submit">Back to Sign in</a>
            </div>
        </div>
        <div class="login-trademark">
            <span style="color:#fff;">&copy; ConnectedMD Inc. 2016</span>
        </div>
    </div>

    <div id="form-request" class="invite-view" style="display:none;">
        <div class="invite-prompt">
            <h1 class="invite-icon"><i class="pe-7s-note2"></i></h1>
            <h3>Form Request</h3>
            <span class="signup-subtext">You've received a request to fill out a form</span>
            <span class="signup-subtext subtext-prompt">What would you like to do?</span>
        </div>
       <div class="invite-card">
           <div class="invite-card-nav">
               <div class="icon-tag">
                   <i class="pe-7s-note2"></i>
               </div>
               <div class="icon-title">
                   <h4 class="practice-name">
                       Anderson Medical
                   </h4>
               </div>
           </div>
           <div class="invite-card-body">
               <div class="form-name-container"><h3 class="form-name">Patient Onboarding Questionaire</h3></div>
               <div style="margin-top: 20px;"><button class="btn btn-success btn-fill">View Form</button></div>
           </div>
       </div>
    </div>

    <div id="invite" class="invite-view" style="display:none;">
        <div class="invite-prompt">
            <div class="invite-title">
                <h1 class="invite-icon"><i class="pe-7s-add-user"></i></h1>
                <h3>You're almost done!</h3>
            </div>
            <span class="signup-subtext">Fill in the fields below to complete and create your account</span>
            <span class="signup-subtext subtext-prompt" style="margin-top:20px;">Verify your information</span>
        </div>
        <div class="invite-card" style="margin-bottom:20px;">
            <div class="invite-card-nav">
                <div class="icon-tag">
                    <i class="pe-7s-add-user"></i>
                </div>
            </div>
            <div class="icon-title">
                <h4 class="practice-name">
                    Invite from <strong>St. Agnes Medical Center</strong>
                </h4>
            </div>
            <div class="invite-card-body">
                <!--<div class="form-name-container"><h3 class="form-name">Patient Onboarding Questionaire</h3></div>-->

                <div class="invite-form">
                    <div class="invite-input-box">
                        <input type="email" class="form-control invite-input" id="invite_email" placeholder="Email" autocomplete="off">
                    </div>
                    <div class="invite-input-box">
                        <input type="password" class="form-control invite-input" id="invite_password" placeholder="Password">
                    </div>
                    <div class="invite-input-box">
                        <input type="password" class="form-control invite-input" id="invite_confirm_password" placeholder="Password Again">
                    </div>
                    <div class="invite-submit-box">
                        <button class="btn btn-success btn-fill invite-btn-submit">Sign up</button>
                    </div>
                    <div class="invite-terms-box">
                        <span>By signing up for an account, you agree to our</span><br>
                        <span class="invite-terms-link"><strong>Terms of Service</strong></span>&nbsp;&&nbsp;
                        <span class="invite-terms-link"><strong>Privacy Policy</strong></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

   <!-- -->
   <div id="changePassword" class="signup-view" style="display:none;">
       <div class="forgot-prompt">
           <h1 class="forgot-icon"><i class="pe-7s-door-lock"></i></h1>
           <h3>Reset your password</h3>
           <span class="signup-subtext">Reset your password by entering a new one and clicking the button below</span>
       </div>
       <div class="signup-form">
           <div class="signup-input-box">
               <input id="resetpassword" type="password" class="form-control input-lg signup-input" id="changeEmail" placeholder="New Password" autocomplete="off">
           </div>
           <div class="signup-submit-box">
               <button id="save_password" class="btn btn-success btn-fill btn-lg signup-btn-submit">Reset Password</button>
           </div>
       </div>
       <div class="signup-footer">
           <div>
               <span class="signup-message" style="margin-right:15px; color:#fff;">Return to login?</span>
               <a class="sign-up-link" style="color:#16FFFF;" onclick="showPanel('login')">Click here</a>
           </div>
       </div>
   </div>

   <script src="/libs/jquery/js/jquery.min.js"></script>
   <script src="/libs/bootstrap/js/bootstrap.min.js"></script>


    <script>
        $("#email, #password").keypress(function (event) {
           if (event.which == 13) { login(); }
        });
        baseAPI = "<%=API%>";
        if (baseAPI == "<%=API%>" || baseAPI == "") {baseAPI = "http://qaapi.connected.md/"}
        createCookie("TOKEN", "", -1);
        $("#password").on("keypress click focus blur", function (e) { checkCapsLock(e, $("#login .capsLockMsg")); });
        $("#registerPassword").on("keypress click focus blur", function (e) { checkCapsLock(e, $("#register .capsLockMsg")); });
        $("#registerConfirmPassword").on("keypress click focus blur", function (e) { checkCapsLock(e, $("#register .capsLockMsg")); });
        $("#login_signup").on("click", function(e){ $("#login").hide(); $("#register").show();});
        $("#reset_password").on("click", forgotPassword);

        var checkCapsLock = function (e, m) {
           m.html("");
           var ev = e ? e : window.event;
           if (!ev) { alert(e); return; }
           var targ = ev.target ? ev.target : ev.srcElement;
           // get key pressed
           var which = -1;
           if (ev.which) {
              which = ev.which;
           } else if (ev.keyCode) {
              which = ev.keyCode;
           }
           // get shift status
           var shift_status = false;
           if (ev.shiftKey) {
              shift_status = ev.shiftKey;
           } else if (ev.modifiers) {
              shift_status = !!(ev.modifiers & 4);
           }
           // Upper Case letter input
           if(which >= 65 && which < 90) {
              if (!shift_status) {
                 // Shift is not being pressed, turn the message on
                 m.html("Caps Lock is on");
              }
           }
           // Lower Case letter input
           else if(which >= 97 && which <= 122) {
              if(shift_status){
                 // Shift is being pressed, turn the message on
                 m.html("Caps Lock is on");
              }
           }
        };
        var showPanel = function (panel) {
           $("#login").hide();
           $("#register").hide();
           $("#forgotPassword").hide();
           $("#changePassword").hide();
           $("#"+panel).show("fast");
        };
        var loginSkip = function () {
            $("#loginError").html("");
            $("#emailError").html("");
            $("#passwordError").html("");
            createCookie("TOKEN", "TEST", 1);
            document.location.href = "/app.html";
        };
        var login = function () {
            $("#loginError").html("");
            $("#emailError").html("");
            $("#passwordError").html("");
            var ok = true;
            if (!validateEmail($("#email").val())) { ok = false; $("#emailError").html("Invalid Email Address."); }
            if ($("#password").val().length <= 3) { ok = false; $("#passwordError").html("Password Required."); }
            if (ok) {
                $.ajax({crossDomain: true, dataType: "json", method: "POST", url: baseAPI + "login", data: { "email": $("#email").val(), "password": $("#password").val() } })
                    .error(function(result) {
                        console.log("Login Error:",result);
                        if (result.responseJSON) {
                            if (result.responseJSON.error) {
                                $("#loginError").html(result.responseJSON.error);
                            } else {
                                $("#loginError").html(result.responseText);
                            }
                        } else {
                            $("#loginError").html("Email or Password Invalid.");
                        }
                    })
                    .done(function(data) {
                        if (data.error) {
                        console.log("Login Response:",data.error);
                            $("#loginError").html(data.error);
                        } else if (data.token !== null && data.token !== "") {
                            createCookie("TOKEN", data.token, 1);
                            document.location.href = "/app.html";
                        } else {
                            $("#loginError").html("Token Invalid.");
                        }
                    })
                ;
            }
        };
        var forgotPassword = function () {
           if (validateEmail($("#forgotPasswordEmail").val()) ) {
              $.ajax({crossDomain: true, dataType: "json", method: "POST", url: baseAPI + "forgotPassword", data: { "email": $("#forgotPasswordEmail").val() } })
                 .error(function(result) {
                    console.log(result.responseJSON);
                    $(".errorMsg").html("");
                 })
                 .done(function(data) {
                    console.log(data);
                 })
              ;
           } else {
              $("#forgotPassword .errmsg").html("Invalid Email Address");
           }
        }
        var register = function() {
            $("#registerError").html("");
            var ok = true;
            var registerEmail = $("#registerEmail").val();
            var registerFirstName = $("#registerFirstName").val();
            var registerLastName = $("#registerLastName").val();
            var registerPassword = $("#registerPassword").val();
            var registerConfirmPassword = $("#registerConfirmPassword").val();
            if (registerPassword !== registerConfirmPassword) { ok = false; }
            if (!validateEmail(registerEmail)) { ok = false; }
            if (registerFirstName.length <= 1) { ok = false; }
            if (registerFirstName.length <= 1) { ok = false; }
            if (ok) {
                $.ajax({crossDomain: true, dataType: "json", method: "POST", url: baseAPI + "signup",
                data: {
                    "email": registerEmail,
                    "firstname": registerFirstName,
                    "lastname": registerLastName,
                    "password": registerPassword,
                    "confirmPassword": registerConfirmPassword
                }})
                .error(function(result) {
                    console.log(result);
                    $("#registerError").html("Sigup Failed with error");
                })
                .done(function(data) {
                    if (data.error) {
                        $("#registerError").html(data.error);
                    } else {
                        if (data.accountCreated === "true") {
                        alert("Signup Complete.\nProceed to login.");
                        document.location.href = "/";
                        }
                        $("#registerError").html("Sigup Failed");
                    }
                })
                ;
            } else {
                $("#registerError").html("All fields required.");
            }
        };
        var changePassword = function () {
            ok = true;
            var changeNewPassword = $("#changeNewPassword").val();
            var changeConfirmPassword = $("#changeConfirmPassword").val();
            if (changeNewPassword == "") { ok = false; }
            if (changeConfirmPassword == "") { ok = false; }
            if (changeNewPassword !== changeConfirmPassword) { ok = false; }
            if (ok) {
                $.ajax({crossDomain: true, dataType: "json", method: "POST", url: baseAPI + "updatePassword",
                data: {
                    "token": getUrlParameter("token"),
                    "password": changeNewPassword
                }})
                .error(function(result) {
                    console.log(result.responseJSON);
                    $("#changePasswordError").html("Error Resetting Password");
                })
                .done(function(data) {
                    console.log(data);
                    if (data.error) {
                        $("#changePasswordError").html(data.error);
                    } else {
                        alert("Password changed.");
                        document.location.href = "/";
                    }
                });
            } else {
                $("#changePasswordError").html("Password does not match");
            }
        };
        var validateEmail = function(email) {
           if (email.length == 0) return false;
           var regex = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/i;
           return regex.test(email);
        };
        var getUrlParameter = function getUrlParameter(sParam) {
           var sPageURL = decodeURIComponent(window.location.search.substring(1)), sURLVariables = sPageURL.split('&'), sParameterName, i;
           for (i = 0; i < sURLVariables.length; i++) {
              sParameterName = sURLVariables[i].split('=');
              if (sParameterName[0] === sParam) {
                 return sParameterName[1] === undefined ? true : sParameterName[1];
              }
           }
        };
        if (getUrlParameter("token") != undefined) { showPanel("changePassword"); }

        function getCookie(name) { return (name = (document.cookie + ';').match(new RegExp(name + '=.*;'))) && name[0].split(/=|;/)[1]; }

        function createCookie(name,value,days) {
            var expires = "";
            if (days) {
                var date = new Date();
                date.setTime(date.getTime()+(days*24*60*60*1000));
                expires = "; expires="+date.toGMTString();
            }
            document.cookie = name+"="+value+expires+"; path=/";
        }
    </script>
</body>
</html>
