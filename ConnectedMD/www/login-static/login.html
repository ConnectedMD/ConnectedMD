<!DOCTYPE html>
<html lang="<%=LANG%>">
<head>
   <meta charset="utf-8" />
   <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
   <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
   <link rel="icon" type="image/ico" href="/favicon.ico"/>
   <title>Log in</title>
   <link href="/libs/bootstrap/css/bootstrap.min.css" rel="stylesheet"/>
   <link href="/libs/font-awesome/css/font-awesome.min.css" rel="stylesheet"/>
   <link href="/css/animate.min.css" rel="stylesheet"/>
   <link href="/css/features.css" rel="stylesheet"/>
   <link href="/css/app.css" rel="stylesheet"/>
</head>
<body class="login-body">

   <!-- -->
    <div id="login" class="login-view">
        <div class="login-view-overlay"></div>
        <div class="login-container">
            <div class="login-brand-container">
                <div class="row">
                    <div class="col-md-12" style="text-align: center;">
                        <h1 class="login-brand"><i class="pe-7s-plugin"></i></h1>
                        <h1 class="login-brand">
                            Connected MD</h1>
                        <hr />
                        <h6 class="login-brand-subtext center-block">Feel better &nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;Live better</h6>
                    </div>
                </div>
            </div>
            <div class="login-social">
                <a href="" class="login-social-btn"><i class="fa fa-facebook-square login-icon"></i></a>
                <a href="" class="login-social-btn"><i class="fa fa-google login-icon"></i></a>
                <a href="" class="login-social-btn"><i class="fa fa-windows login-icon"></i></a>
            </div>
            <div class="login-option"><strong>or</strong></div>
            <div class="login-form">
                <div class="row">
                    <div class="col-md-12">
                        <input type="email" class="form-control input-lg login-input" id="email" placeholder="Email">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <input type="password" class="form-control input-lg login-input" id="password" placeholder="Password">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <button type="button" class="btn btn-primary btn-lg btn-block login-btn">Sign in</button>
                    </div>
                </div>
            </div>
            <div class="signup-footer">
               <div>
                  <span class="signup-message" style="margin-right:15px;">Don't have an account?</span>
                  <a class="sign-up-link" onclick="showPanel('register')">Sign up</a>
               </div>
               <div>
                  <span class="signup-message" style="margin-right:15px;">Forgot your password?</span>
                  <a class="sign-up-link" onclick="showPanel('forgotPassword')">Click here</a>
               </div>
            </div>
            <div class="login-trademark">
                <span style="color:#827E7E;">&copy; ConnectedMD Inc. 2016</span>
            </div>
        </div>
    </div>
    
   <!-- -->
    <div id="register" class="signup-view">
        <div class="signup-prompt">
            <h4>SIGN UP</h4>
            <span class="signup-subtext">Get started using ConnectedMD with an account</span>
        </div>
        <div class="signup-social">
            <button class="btn btn-primary btn-lg btn-fill signup-btn-social">Signup with Facebook</button>
        </div>
        <div class="signup-form">
            <div class="signup-input-box">
                <input type="email" class="form-control input-lg signup-input" id="email" placeholder="Email" autocomplete="off">
            </div>
            <div class="signup-input-box">
                <input type="password" class="form-control input-lg signup-input" id="password" placeholder="Password">
            </div>
            <div class="signup-input-box">
                <input type="password" class="form-control input-lg signup-input" id="confirm_password" placeholder="Password Again">
            </div>
            <div class="signup-submit-box">
                <button class="btn btn-success btn-fill btn-lg signup-btn-submit">Sign up with Email</button>
            </div>
            <div class="signup-terms-box">
                <span>By signing up for an account, you agree to our</span><br>
                <span class="signup-terms-link"><strong>Terms of Service</strong></span>&nbsp;&&nbsp;
                <span class="signup-terms-link"><strong>Privacy Policy</strong></span>
            </div>
        </div>
    </div>

   <!-- -->
   <div id="forgotPassword" class="signup-view">
      <div class="signup-prompt">
         <h4>FORGOT PASSWORD</h4>
         <span class="signup-subtext">Get your ConnectedMD account information</span>
      </div>
      <div class="signup-form">
      </div>
      <div class="signup-footer">
         <div>
            <span class="signup-message" style="margin-right:15px;">Don't have an account?</span>
            <a class="sign-up-link" onclick="showPanel('register')">Sign up</a>
         </div>
         <div>
            <span class="signup-message" style="margin-right:15px;">Forgot your password?</span>
            <a class="sign-up-link" onclick="showPanel('forgotPassword')">Click here</a>
         </div>
      </div>
      <div class="login-trademark">
         <span style="color:#827E7E;">&copy; ConnectedMD Inc. 2016</span>
      </div>
   </div>
    
   <!-- -->
   <div id="changePassword" class="signup-view">

   </div>

   <script src="/libs/jquery/js/jquery.min.js"></script>
   <script src="/libs/bootstrap/js/bootstrap.min.js"></script>

<script>
$("#email, #password").keypress(function (event) {
   if (event.which == 13) { login(); }
});
baseAPI = "<%=API%>";
//createCookie("TOKEN", "", -1);
$("#password").on("keypress click focus blur", function (e) { checkCapsLock(e, $("#login .capsLockMsg")); });
$("#registerPassword").on("keypress click focus blur", function (e) { checkCapsLock(e, $("#register .capsLockMsg")); });
$("#registerConfirmPassword").on("keypress click focus blur", function (e) { checkCapsLock(e, $("#register .capsLockMsg")); });

var checkCapsLock = function (e, m) {
   m.html("");
   var ev = e ? e : window.event;
   if (!ev) { alert(e); return; }
   var targ = ev.target ? ev.target : ev.srcElement;
   // get key pressed
   var which = -1;
   if (ev.which) {
      which = ev.which;
   } else if (ev.keyCode) {
      which = ev.keyCode;
   }
   // get shift status
   var shift_status = false;
   if (ev.shiftKey) {
      shift_status = ev.shiftKey;
   } else if (ev.modifiers) {
      shift_status = !!(ev.modifiers & 4);
   }
   // Upper Case letter input
   if(which >= 65 && which < 90) {
      if (!shift_status) {
         // Shift is not being pressed, turn the message on
         m.html("Caps Lock is on");
      }
   }
   // Lower Case letter input
   else if(which >= 97 && which <= 122) {
      if(shift_status){
         // Shift is being pressed, turn the message on
         m.html("Caps Lock is on");
      }
   }
};
var showPanel = function (panel) {
   $("#login").hide();
   $("#register").hide();
   $("#forgotPassword").hide();
   $("#changePassword").hide();
   $("#"+panel).show("fast");
};
var login = function () {
   $("#loginError").html("");
   $("#emailError").html("");
   $("#passwordError").html("");
   var ok = true;
   if (!validateEmail($("#email").val())) { ok = false; $("#emailError").html("Invalid Email Address."); }
   if ($("#password").val().length <= 3) { ok = false; $("#passwordError").html("Password Required."); }
   if (ok) {
      $.ajax({crossDomain: true, dataType: "json", method: "POST", url: baseAPI + "login", data: { "email": $("#email").val(), "password": $("#password").val() } })
         .error(function(result) {
            if (result.responseJSON) {
               if (result.responseJSON.error) {
                  $("#loginError").html(result.responseJSON.error);
               } else {
                  $("#loginError").html(result.responseText);
               }
            } else {
               $("#loginError").html("Email or Password Invalid.");
            }
         })
         .done(function(data) {
            if (data.error) {
               $("#loginError").html(data.error);
            } else if (data.token !== null && data.token !== "") {
               createCookie("TOKEN", data.token, 1);
               document.location.href = "/";
            } else {
               $("#loginError").html("Token Invalid.");
            }
         })
      ;
   }
};

var forgotPassword = function () {
   if (validateEmail($("#forgotPasswordEmail").val()) ) {
      $.ajax({crossDomain: true, dataType: "json", method: "POST", url: baseAPI + "forgotPassword", data: { "email": $("#forgotPasswordEmail").val() } })
         .error(function(result) {
            console.log(result.responseJSON);
            $(".errorMsg").html("");
         })
         .done(function(data) {
            console.log(data);
         })
      ;
   } else {
      $("#forgotPassword .errmsg").html("Invalid Email Address");
   }
}

var register = function() {
      $("#registerError").html("");
      var ok = true;
      var registerEmail = $("#registerEmail").val();
      var registerFirstName = $("#registerFirstName").val();
      var registerLastName = $("#registerLastName").val();
      var registerPassword = $("#registerPassword").val();
      var registerConfirmPassword = $("#registerConfirmPassword").val();
      if (registerPassword !== registerConfirmPassword) { ok = false; }
      if (!validateEmail(registerEmail)) { ok = false; }
      if (registerFirstName.length <= 1) { ok = false; }
      if (registerFirstName.length <= 1) { ok = false; }
      if (ok) {
         $.ajax({crossDomain: true, dataType: "json", method: "POST", url: baseAPI + "signup", 
            data: {
                  "email": registerEmail,
                  "firstname": registerFirstName, 
                  "lastname": registerLastName, 
                  "password": registerPassword,
                  "confirmPassword": registerConfirmPassword
            }})
            .error(function(result) {
                  console.log(result);
                  $("#registerError").html("Sigup Failed with error");
            })
            .done(function(data) {
                  if (data.error) {
                     $("#registerError").html(data.error);
                  } else {
                     if (data.accountCreated === "true") {
                        alert("Signup Complete.\nProceed to login.");
                        document.location.href = "/";
                     }
                     $("#registerError").html("Sigup Failed");
                  }
            })
         ;
      } else {
         $("#registerError").html("All fields required.");
      }
};
var changePassword = function () {
      ok = true;
      var changeNewPassword = $("#changeNewPassword").val();
      var changeConfirmPassword = $("#changeConfirmPassword").val();
      if (changeNewPassword == "") { ok = false; }
      if (changeConfirmPassword == "") { ok = false; }
      if (changeNewPassword !== changeConfirmPassword) { ok = false; }
      if (ok) {
         $.ajax({crossDomain: true, dataType: "json", method: "POST", url: baseAPI + "updatePassword", 
            data: {
                  "token": getUrlParameter("token"),
                  "password": changeNewPassword
            }})
            .error(function(result) {
                  console.log(result.responseJSON);
                  $("#changePasswordError").html("Error Resetting Password");
            })
            .done(function(data) {
                  console.log(data);
                  if (data.error) {
                     $("#changePasswordError").html(data.error);
                  } else {
                     alert("Password changed.");
                     document.location.href = "/";
                  }
            })
         ;
      } else {
         $("#changePasswordError").html("Password does not match");
      }
};
var validateEmail = function(email) {
   if (email.length == 0) return false;
   var regex = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/i;
   return regex.test(email);
};
var getUrlParameter = function getUrlParameter(sParam) {
   var sPageURL = decodeURIComponent(window.location.search.substring(1)), sURLVariables = sPageURL.split('&'), sParameterName, i;
   for (i = 0; i < sURLVariables.length; i++) {
      sParameterName = sURLVariables[i].split('=');
      if (sParameterName[0] === sParam) {
         return sParameterName[1] === undefined ? true : sParameterName[1];
      }
   }
};
if (getUrlParameter("token") != undefined) { showPanel("changePassword"); }
</script>
</body>
</html>
